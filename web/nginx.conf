server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  # --- Security / sane defaults ---
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "no-referrer-when-downgrade" always;

  # =========================================================
  # 1) HTML / SPA shell: NEVER cache (prevents "stuck" UI)
  # =========================================================
  location = / {
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    add_header Pragma "no-cache" always;
    expires -1;
    try_files /index.html =404;
  }

  location = /index.html {
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    add_header Pragma "no-cache" always;
    expires -1;
    try_files $uri =404;
  }

  # =========================================================
  # 2) PWA critical files: ALWAYS fresh
  # =========================================================
  location = /sw.js {
    add_header Cache-Control "no-store, max-age=0" always;
    expires -1;
    try_files $uri =404;
  }

  location = /manifest.webmanifest {
    add_header Cache-Control "no-store, max-age=0" always;
    expires -1;
    try_files $uri =404;
  }

  # optional: if you use registerSW with workbox, sometimes it creates /workbox-*.js
  location ~* ^/workbox-.*\.js$ {
    add_header Cache-Control "no-store, max-age=0" always;
    expires -1;
    try_files $uri =404;
  }

  # =========================================================
  # 3) Versioned assets: cache forever (Vite outputs hashed filenames)
  # =========================================================
  location ^~ /assets/ {
    try_files $uri =404;
    expires 365d;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
  }

  location ^~ /icons/ {
    try_files $uri =404;
    expires 365d;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
  }

  # common static files
  location ~* \.(?:css|js|mjs|map|png|jpg|jpeg|gif|svg|webp|ico|woff2?|ttf|eot)$ {
    try_files $uri =404;
    expires 365d;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
  }

  # =========================================================
  # 4) SPA fallback (React Router)
  # =========================================================
  location / {
    # Important: serve real files first, otherwise fallback to index.html
    try_files $uri $uri/ /index.html;
  }
}
